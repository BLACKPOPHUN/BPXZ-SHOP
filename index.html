<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPXZ SHOP - SECURE SYSTEM V3</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #e63946; --dark-bg: #0f0f0f; --card-bg: #1a1a1a; --input-bg: #252525; --text-main: #ffffff; --text-dim: #a0a0a0; --success: #2b9348; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Kanit', sans-serif; }
        body { background-color: var(--dark-bg); color: var(--text-main); line-height: 1.6; }
        nav { background: #000; color: #fff; padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid var(--primary); }
        nav h1 { color: var(--primary); font-size: 1.8rem; font-weight: 900; cursor: pointer; }
        .nav-links { display: flex; gap: 15px; align-items: center; }
        .nav-links button { background: none; border: none; color: var(--text-dim); cursor: pointer; transition: 0.3s; }
        .btn-red { background: var(--primary) !important; color: white !important; padding: 8px 18px; border-radius: 5px; font-weight: bold; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .section { display: none; background: var(--card-bg); padding: 2.5rem; border-radius: 12px; border: 1px solid #333; }
        .section.active { display: block; animation: fadeIn 0.4s ease; }
        .category-filter { display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; padding-bottom: 10px; }
        .cat-btn { background: #222; border: 1px solid #444; color: white; padding: 8px 20px; border-radius: 20px; cursor: pointer; white-space: nowrap; transition: 0.3s; }
        .cat-btn.active { background: var(--primary); border-color: var(--primary); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        form { display: flex; flex-direction: column; gap: 15px; max-width: 450px; margin: 0 auto; }
        input, select { background: var(--input-bg); border: 1px solid #444; color: white; padding: 14px; border-radius: 8px; width: 100%; }
        .btn-main, button[type="submit"] { background: var(--primary); color: white; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; }
        button:disabled { background: #555 !important; cursor: not-allowed; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .product-card { background: var(--card-bg); border: 1px solid #333; border-radius: 15px; overflow: hidden; position: relative; }
        .product-tag { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 2px 10px; border-radius: 5px; font-size: 12px; color: var(--primary); border: 1px solid var(--primary); }
        .product-img { width: 100%; height: 200px; object-fit: cover; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #333; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: var(--card-bg); padding: 2rem; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--primary); }
    </style>
</head>
<body>

    <nav>
        <h1 onclick="goHome()">BPXZ<span>SHOP</span></h1>
        <div class="nav-links" id="navAuth">
            <button onclick="showSection('login')">LOGIN</button>
            <button onclick="showSection('register')" class="btn-red">REGISTER</button>
        </div>
        <div class="nav-links" id="navUser" style="display: none;">
            <span id="userNameDisp" style="color: var(--text-dim);"></span>
            <button onclick="showSection('shop')">üõí ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</button>
            <button id="adminBtn" class="btn-red" style="display: none;" onclick="showSection('admin')">‚öôÔ∏è ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
            <button onclick="logout()" style="color: var(--primary);">OFF</button>
        </div>
    </nav>

    <div class="container">
        <section id="login" class="section active">
            <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <form onsubmit="handleLogin(event)">
                <input type="text" id="loginId" placeholder="Email ‡∏´‡∏£‡∏∑‡∏≠ Admin ID" required>
                <input type="password" id="loginPass" placeholder="Password" required>
                <button type="submit">LOGIN</button>
            </form>
        </section>

        <section id="register" class="section">
            <h2>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
            <form onsubmit="handleRegister(event)">
                <input type="text" id="regName" placeholder="Username" required>
                <input type="email" id="regEmail" placeholder="Email" required>
                <input type="password" id="regPass" placeholder="Password" required minlength="6">
                <button type="submit" class="btn-red">REGISTER</button>
            </form>
        </section>

        <section id="shop" class="section">
            <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
            <div class="category-filter" id="catFilter"></div>
            <div id="productGrid" class="product-grid"></div>
        </section>

        <section id="admin" class="section">
            <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö (Admin Only)</h2>
            <form onsubmit="handleProductSubmit(event)" id="productForm" style="margin-bottom: 30px; background: #111; padding: 20px; border-radius: 10px;">
                <input type="hidden" id="editId">
                <input type="text" id="pName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" required>
                <input type="text" id="pCategory" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà" required>
                <input type="text" id="pImg" placeholder="Link ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" required>
                <input type="number" id="pPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" required>
                <input type="number" id="pStock" placeholder="‡∏™‡∏ï‡πä‡∏≠‡∏Å" required>
                <input type="text" id="pLink" placeholder="Link ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î" required>
                <button type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            </form>
            
            <h3>‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            <div style="overflow-x: auto; margin-bottom: 40px;">
                <table>
                    <thead><tr><th>‡∏´‡∏°‡∏ß‡∏î</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏™‡∏ï‡πä‡∏≠‡∏Å</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                    <tbody id="adminTableBody"></tbody>
                </table>
            </div>

            <h3 style="margin-top: 30px; color: var(--primary);">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (LOG)</h3>
            <div style="overflow-x: auto;">
                <table>
                    <thead><tr><th>‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏ã‡∏≠‡∏á</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th></tr></thead>
                    <tbody id="orderTableBody"></tbody>
                </table>
            </div>
        </section>
    </div>

    <div id="buyModal" class="modal">
        <div class="modal-content">
            <h3 id="buyItemName"></h3>
            <p>‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞: <span id="buyItemPrice" style="color:var(--primary); font-size:1.5rem;"></span> ‡∏ø</p>
            <input type="text" id="walletLink" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ã‡∏≠‡∏á‡∏≠‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏≤..." style="margin: 15px 0;">
            <button class="btn-main" id="payBtn" onclick="processPayment()">‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
            <div id="downloadBox" style="display:none; margin-top:20px; border:2px solid var(--success); padding:15px; border-radius: 8px;">
                <a id="dlLink" href="#" target="_blank" style="color:#fff; text-decoration:none; display:block;">‚úÖ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</a>
            </div>
            <button onclick="closeModal()" style="margin-top:15px; background:none; border:none; color:gray; cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å / ‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const _0x1a2b=['\x62\x70\x78\x7a\x73\x32\x2e\x66\x69\x72\x65\x62\x61\x73\x65\x61\x70\x70\x2e\x63\x6f\x6d','\x62\x70\x78\x7a\x73\x32','\x62\x70\x78\x7a\x73\x32\x2e\x66\x69\x72\x65\x62\x61\x73\x65\x73\x74\x6f\x72\x61\x67\x65\x2e\x61\x70\x70','\x31\x39\x39\x34\x38\x32\x31\x33\x32\x36\x30\x34','\x31\x3a\x31\x39\x39\x34\x38\x32\x31\x33\x32\x36\x30\x34\x3a\x77\x65\x62\x3a\x65\x61\x38\x38\x37\x64\x37\x35\x65\x64\x31\x64\x32\x30\x31\x35\x61\x36\x36\x31\x66\x39','\x41\x49\x7a\x61\x53\x79\x44\x41\x6e\x4a\x7a\x6c\x6e\x31\x72\x65\x39\x43\x42\x49\x71\x61\x32\x4c\x6f\x6f\x55\x6c\x73\x41\x6e\x33\x76\x63\x77\x47\x4e\x4f\x63'];
        const _0x5c4a = {apiKey:_0x1a2b[5],authDomain:_0x1a2b[0],projectId:_0x1a2b[1],storageBucket:_0x1a2b[2],messagingSenderId:_0x1a2b[3],appId:_0x1a2b[4]};
        const app = initializeApp(_0x5c4a);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const _0x9b2e = '\x62\x70\x78\x7a\x73\x68\x6f\x70\x31\x33';
        const _0x2a1f = '\x32\x33\x33\x37\x39\x35\x32\x62';
        const _0x7d3c = '\x5f\x73\x65\x63\x75\x72\x65\x5f\x61\x64\x6d\x69\x6e\x5f\x73\x65\x73\x73\x69\x6f\x6e';

        let p=[],cu=null,cbi=null,sc='\x41\x6c\x6c';

        window.showSection=(id)=>{document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));if(id==='admin'&&!localStorage.getItem(_0x7d3c))return showSection('login');document.getElementById(id).classList.add('active');};
        window.goHome=()=>{if(localStorage.getItem(_0x7d3c))showSection('admin');else if(auth.currentUser)showSection('shop');else showSection('login');};
        
        onAuthStateChanged(auth,async(u)=>{if(u){const s=await getDoc(doc(db,'users',u.uid));if(s.exists()){cu=s.data();document.getElementById('navAuth').style.display='none';document.getElementById('navUser').style.display='flex';document.getElementById('userNameDisp').innerText=`USER: ${cu.name}`;if(!localStorage.getItem(_0x7d3c))showSection('shop');}}else if(!localStorage.getItem(_0x7d3c)){document.getElementById('navAuth').style.display='flex';document.getElementById('navUser').style.display='none';showSection('login');}});
        
        if(localStorage.getItem(_0x7d3c)){document.getElementById('navAuth').style.display='none';document.getElementById('navUser').style.display='flex';document.getElementById('adminBtn').style.display='block';showSection('admin');}

        window.handleLogin=async(e)=>{e.preventDefault();const i=document.getElementById('loginId').value,p=document.getElementById('loginPass').value;if(i===_0x9b2e&&p===_0x2a1f){localStorage.setItem(_0x7d3c,Date.now());location.reload();}else{try{await signInWithEmailAndPassword(auth,i,p);}catch(x){alert('\x45\x72\x72\x6f\x72');}}};
        window.handleRegister=async(e)=>{e.preventDefault();const n=document.getElementById('regName').value,em=document.getElementById('regEmail').value,ps=document.getElementById('regPass').value;try{const r=await createUserWithEmailAndPassword(auth,em,ps);await setDoc(doc(db,'users',r.user.uid),{name:n,role:'user'});alert('\x53\x75\x63\x63\x65\x73\x73');showSection('login');}catch(x){alert(x.message);}};
        window.logout=()=>{localStorage.removeItem(_0x7d3c);signOut(auth).then(()=>location.reload());};

        // Snapshot Products
        onSnapshot(collection(db,'products'),(s)=>{p=s.docs.map(d=>({id:d.id,...d.data()}));rc();rs();rat();});
        
        // Snapshot Orders (Admin Only)
        onSnapshot(query(collection(db,'orders'),orderBy('timestamp','desc'),limit(50)),(s)=>{
            if(localStorage.getItem(_0x7d3c)){
                document.getElementById('orderTableBody').innerHTML=s.docs.map(d=>{
                    const o=d.data();
                    return `<tr><td>${o.userName}</td><td>${o.productName}</td><td><b style="color:var(--success)">${o.actualAmount}</b></td><td><a href="${o.walletLink}" target="_blank" style="color:var(--primary)">‡∏•‡∏¥‡πâ‡∏á‡∏ã‡∏≠‡∏á</a></td><td>${new Date(o.timestamp).toLocaleString()}</td></tr>`;
                }).join('');
            }
        });

        window.processPayment=async()=>{
            const l=document.getElementById('walletLink').value,b=document.getElementById('payBtn');
            if(!l.includes('\x67\x69\x66\x74\x2e\x74\x72\x75\x65\x6d\x6f\x6e\x65\x79\x2e\x63\x6f\x6d')) return alert('\x4c\x69\x6e\x6b\x20\x45\x72\x72\x6f\x72');
            b.disabled=true; b.innerText="Wait...";
            try{
                const f=new FormData();
                f.append('keyapi','\x33\x33\x63\x36\x30\x65\x62\x65\x66\x63\x65\x34\x34\x62\x32\x36\x36\x30\x61\x33\x32\x36\x65\x64\x37\x33\x33\x35\x64\x38\x64\x65');
                f.append('phone','\x30\x39\x35\x30\x31\x38\x39\x39\x38\x33');
                f.append('gift_link',l);
                const r=await fetch('\x68\x74\x74\x70\x73\x3a\x2f\x2f\x77\x77\x77\x2e\x70\x6c\x61\x6e\x61\x72\x69\x61\x73\x68\x6f\x70\x2e\x63\x6f\x6d\x2f\x61\x70\x69\x2f\x74\x72\x75\x65\x77\x61\x6c\x6c\x65\x74\x2e\x70\x68\x70',{method:'POST',body:f}).then(x=>x.json());
                
                if(r.status==='\x73\x75\x63\x63\x65\x73\x73' && parseFloat(r.amount)>=cbi.price){
                    // Fix Bug: Update Stock & Save Order
                    await addDoc(collection(db,'orders'),{userName:cu?cu.name:"Guest",productName:cbi.name,price:cbi.price,actualAmount:r.amount,walletLink:l,timestamp:new Date().toISOString()});
                    await updateDoc(doc(db,'products',cbi.id),{stock:cbi.stock-1});
                    
                    document.getElementById('dlLink').href=cbi.downloadLink;
                    document.getElementById('downloadBox').style.display='block';
                    document.getElementById('walletLink').style.display='none';
                    b.style.display='none';
                } else { alert('\x46\x61\x69\x6c\x65\x64\x20\x4f\x72\x20\x49\x6e\x76\x61\x6c\x69\x64'); }
            }catch(x){alert('\x53\x79\x73\x74\x65\x6d\x20\x45\x72\x72\x6f\x72');}
            b.disabled=false; b.innerText="PAY";
        };

        window.rc=()=>{const c=['\xaa\xd1\xe9\xa7\xba\xc1\xb4',...new Set(p.map(x=>x.category))];document.getElementById('catFilter').innerHTML=c.map(x=>`<button class="cat-btn ${sc===x?'active':''}" onclick="fc('${x}')">${x}</button>`).join('');};
        window.fc=(c)=>{sc=c;rs();};
        
        // Fix Bug: Disable buy button if stock <= 0
        window.rs=()=>{
            const f=sc==='\xaa\xd1\xe9\xa7\xba\xc1\xb4'?p:p.filter(x=>x.category===sc);
            document.getElementById('productGrid').innerHTML=f.map(x=>`
                <div class="product-card">
                    <div class="product-tag">${x.category}</div>
                    <img src="${x.img}" class="product-img" onerror="this.src='https://placehold.co/400x200?text=No+Image'">
                    <div style="padding:15px">
                        <h3>${x.name}</h3>
                        <div style="color:var(--primary);font-size:24px;font-weight:bold;">‡∏ø${x.price}</div>
                        <p style="color:var(--text-dim);font-size:12px;">Stock: ${x.stock}</p>
                        <button class="btn-main" style="margin-top:10px" onclick="obm('${x.id}')" ${x.stock<=0?'disabled':''}>
                            ${x.stock>0?'BUY NOW':'OUT OF STOCK'}
                        </button>
                    </div>
                </div>`).join('');
        };
        
        window.rat=()=>{document.getElementById('adminTableBody').innerHTML=p.map(x=>`<tr><td>${x.category}</td><td>${x.name}</td><td>${x.price}</td><td>${x.stock}</td><td><button onclick="ep('${x.id}')">EDIT</button> <button onclick="dp('${x.id}')">DEL</button></td></tr>`).join('');};
        window.ep=(id)=>{const x=p.find(a=>a.id===id);document.getElementById('editId').value=x.id;document.getElementById('pName').value=x.name;document.getElementById('pCategory').value=x.category;document.getElementById('pImg').value=x.img;document.getElementById('pPrice').value=x.price;document.getElementById('pStock').value=x.stock;document.getElementById('pLink').value=x.downloadLink;window.scrollTo(0,0);};
        window.dp=async(id)=>{if(confirm('\x44\x65\x6c\x65\x74\x65\x3f'))await deleteDoc(doc(db,'products',id));};
        
        window.obm=(id)=>{
            cbi=p.find(x=>x.id===id);
            document.getElementById('buyItemName').innerText=cbi.name;
            document.getElementById('buyItemPrice').innerText=cbi.price;
            document.getElementById('buyModal').style.display='flex';
            document.getElementById('downloadBox').style.display='none';
            document.getElementById('payBtn').style.display='block';
            document.getElementById('walletLink').style.display='block';
            document.getElementById('walletLink').value='';
        };
        window.closeModal=()=>document.getElementById('buyModal').style.display='none';
        
        window.handleProductSubmit=async(e)=>{
            e.preventDefault();
            const id=document.getElementById('editId').value;
            const d={name:document.getElementById('pName').value,category:document.getElementById('pCategory').value,img:document.getElementById('pImg').value,price:Number(document.getElementById('pPrice').value),stock:Number(document.getElementById('pStock').value),downloadLink:document.getElementById('pLink').value};
            if(id)await updateDoc(doc(db,'products',id),d);else await addDoc(collection(db,'products'),d);
            document.getElementById('productForm').reset();document.getElementById('editId').value='';
        };
    </script>
</body>
</html>
