<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPXZ SHOP - Full System</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #ff4d4d; --bg: #0a0a0a; --card: #151515; --text: #fff; --success: #2ecc71; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Kanit',sans-serif; }
        body { background: var(--bg); color: var(--text); }
        nav { background:#000; padding:15px 5%; display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid var(--primary); sticky: top; z-index: 1000; }
        .container { max-width:1000px; margin:30px auto; padding:0 15px; }
        .section { display:none; background:var(--card); padding:30px; border-radius:15px; border:1px solid #222; }
        .active { display:block; }
        .btn-main { background:var(--primary); color:white; padding:12px; border:none; border-radius:8px; cursor:pointer; width:100%; font-weight:bold; margin-bottom:10px; }
        input { background:#222; border:1px solid #333; color:white; padding:12px; border-radius:8px; width:100%; margin-bottom:15px; outline: none; }
        .product-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:20px; }
        .admin-item { background: #222; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 5px solid var(--primary); }
    </style>
</head>
<body>

    <nav>
        <h1 onclick="location.reload()" style="cursor:pointer; color:var(--primary);">BPXZ SHOP</h1>
        <div id="navMenu">
            <button onclick="showSection('login')" style="color:white; background:none; border:none; cursor:pointer;">ล็อกอิน</button>
            <button onclick="showSection('register')" style="color:var(--primary); background:none; border:1px solid var(--primary); padding:5px 10px; border-radius:5px; cursor:pointer; margin-left:10px;">สมัคร</button>
        </div>
        <div id="userMenu" style="display:none;">
            <span id="userDisp" style="font-size:0.8rem; margin-right:10px;"></span>
            <button id="admBtn" onclick="showSection('admin')" style="display:none; color:yellow; background:none; border:none; cursor:pointer;">[จัดการ]</button>
            <button onclick="logout()" style="color:white; background:none; border:none; cursor:pointer; margin-left:10px;">ออก</button>
        </div>
    </nav>

    <div class="container">
        <section id="register" class="section">
            <h2>สมัครสมาชิก</h2>
            <p style="font-size:0.8rem; color:gray; margin-bottom:15px;">*ต้องยืนยันอีเมลก่อนเข้าใช้งาน</p>
            <input type="email" id="regEmail" placeholder="อีเมล">
            <input type="password" id="regPass" placeholder="รหัสผ่าน">
            <button class="btn-main" onclick="handleRegister()">สมัครสมาชิก</button>
        </section>

        <section id="login" class="section active">
            <h2>เข้าสู่ระบบ</h2>
            <input type="text" id="loginEmail" placeholder="อีเมล">
            <input type="password" id="loginPass" placeholder="รหัสผ่าน">
            <button class="btn-main" onclick="handleLogin()">เข้าสู่ระบบ</button>
        </section>

        <section id="admin" class="section">
            <h2>จัดการสินค้า (เพิ่ม/แก้ไข)</h2>
            <div id="editForm" style="background:#111; padding:20px; border-radius:10px; margin-bottom:20px;">
                <input type="hidden" id="editId">
                <input type="text" id="pName" placeholder="ชื่อสินค้า">
                <input type="number" id="pPrice" placeholder="ราคา">
                <input type="text" id="pImg" placeholder="ลิงก์รูป">
                <input type="text" id="pLink" placeholder="ลิงก์ดาวน์โหลด">
                <button class="btn-main" id="saveBtn" onclick="saveProduct()">เพิ่มสินค้าใหม่</button>
                <button id="cancelEdit" onclick="resetForm()" style="display:none; background:none; color:gray; border:none; cursor:pointer;">ยกเลิกการแก้ไข</button>
            </div>
            <div id="adminList"></div>
        </section>

        <section id="shop" class="section">
            <div id="productGrid" class="product-grid"></div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCkKUrj5pHqXUvHMI-JpGWqMwlitGe7b0c",
            authDomain: "bpxzshop-2573c.firebaseapp.com",
            projectId: "bpxzshop-2573c",
            storageBucket: "bpxzshop-2573c.firebasestorage.app",
            messagingSenderId: "51423151593",
            appId: "1:51423151593:web:79c4e1c86fcf6340cff778"
        };

        const API_CONF = {
            url: "https://www.planariashop.com/api/truewallet.php",
            key: "33c60ebefce44b2660a326ed7335d8de",
            phone: "0950189983" // เปลี่ยนเบอร์ที่นี่
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.showSection = (id) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };

        // --- ระบบสมาชิก + ยืนยันอีเมล ---
        window.handleRegister = async () => {
            try {
                const userCred = await createUserWithEmailAndPassword(auth, regEmail.value, regPass.value);
                await sendEmailVerification(userCred.user);
                alert("สมัครสำเร็จ! กรุณาเช็คอีเมลเพื่อกดยืนยันตัวตนก่อนเข้าสู่ระบบ");
                showSection('login');
            } catch (e) { alert(e.message); }
        };

        window.handleLogin = async () => {
            const email = loginEmail.value;
            const pass = loginPass.value;
            if(email === "bpxzshop" && pass === "bpxz7952") {
                localStorage.setItem('isAdmin', 'true'); location.reload(); return;
            }
            try {
                const userCred = await signInWithEmailAndPassword(auth, email, pass);
                if (!userCred.user.emailVerified) {
                    alert("กรุณายืนยันอีเมลของคุณก่อน!");
                    await signOut(auth);
                }
            } catch (e) { alert("ล็อกอินไม่สำเร็จ"); }
        };

        onAuthStateChanged(auth, (user) => {
            const isAdmin = localStorage.getItem('isAdmin');
            if ((user && user.emailVerified) || isAdmin) {
                document.getElementById('navMenu').style.display = 'none';
                document.getElementById('userMenu').style.display = 'block';
                document.getElementById('userDisp').innerText = isAdmin ? "Admin Mode" : user.email;
                if(isAdmin) document.getElementById('admBtn').style.display = 'inline';
                showSection('shop');
            }
        });

        // --- ระบบจัดการสินค้า (เพิ่ม/แก้ไข/ลบ) ---
        let allProducts = [];
        onSnapshot(collection(db, "products"), (snap) => {
            allProducts = snap.docs.map(d => ({id: d.id, ...d.data()}));
            renderProducts();
        });

        function renderProducts() {
            // หน้า Admin
            document.getElementById('adminList').innerHTML = allProducts.map(p => `
                <div class="admin-item">
                    <b>${p.name}</b> - ${p.price}฿
                    <div style="margin-top:5px;">
                        <button onclick="editProduct('${p.id}')" style="color:cyan; background:none; border:none; cursor:pointer;">[แก้ไข]</button>
                        <button onclick="deleteProduct('${p.id}')" style="color:red; background:none; border:none; cursor:pointer; margin-left:10px;">[ลบ]</button>
                    </div>
                </div>`).join('');
            
            // หน้าร้าน
            document.getElementById('productGrid').innerHTML = allProducts.map(p => `
                <div style="background:#222; padding:15px; border-radius:10px; text-align:center;">
                    <img src="${p.img}" style="width:100%; height:120px; object-fit:cover; border-radius:5px;">
                    <h4 style="margin:10px 0;">${p.name}</h4>
                    <button class="btn-main" onclick="alert('ระบบเติมเงิน API พร้อมใช้งาน')">${p.price} ฿ | ซื้อ</button>
                </div>`).join('');
        }

        window.saveProduct = async () => {
            const data = { name: pName.value, price: Number(pPrice.value), img: pImg.value, downloadLink: pLink.value };
            const id = editId.value;
            if (id) {
                await updateDoc(doc(db, "products", id), data);
                alert("แก้ไขสำเร็จ");
            } else {
                await addDoc(collection(db, "products"), data);
                alert("เพิ่มสินค้าสำเร็จ");
            }
            resetForm();
        };

        window.editProduct = (id) => {
            const p = allProducts.find(x => x.id === id);
            editId.value = p.id; pName.value = p.name; pPrice.value = p.price; pImg.value = p.img; pLink.value = p.downloadLink;
            saveBtn.innerText = "บันทึกการแก้ไข";
            document.getElementById('cancelEdit').style.display = 'inline';
            window.scrollTo(0,0);
        };

        window.resetForm = () => {
            editId.value=""; pName.value=""; pPrice.value=""; pImg.value=""; pLink.value="";
            saveBtn.innerText = "เพิ่มสินค้าใหม่";
            document.getElementById('cancelEdit').style.display = 'none';
        };

        window.deleteProduct = async (id) => { if(confirm("ลบสินค้านี้?")) await deleteDoc(doc(db, "products", id)); };

        window.logout = () => { localStorage.clear(); signOut(auth).then(() => location.reload()); };
    </script>
</body>
</html>
