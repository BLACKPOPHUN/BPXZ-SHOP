<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPXZ SHOP</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Kanit:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --red: #e63946;
            --red-glow: rgba(230, 57, 70, 0.4);
            --red-dim: rgba(230, 57, 70, 0.12);
            --bg: #080808;
            --bg2: #0e0e0e;
            --card: #111111;
            --card2: #161616;
            --border: rgba(255,255,255,0.07);
            --border-red: rgba(230,57,70,0.35);
            --text: #f0f0f0;
            --dim: #6a6a6a;
            --dim2: #2e2e2e;
            --green: #22c55e;
            --green-dim: rgba(34,197,94,0.12);
            --input-bg: #0c0c0c;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Kanit', sans-serif; line-height: 1.6; min-height: 100vh; overflow-x: hidden; }
        body.modal-open { overflow: hidden; }
        body::before {
            content: '';
            position: fixed; inset: 0;
            background-image: linear-gradient(rgba(230,57,70,0.025) 1px, transparent 1px), linear-gradient(90deg, rgba(230,57,70,0.025) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none; z-index: 0;
        }

        /* NAV */
        nav {
            background: rgba(8,8,8,0.97);
            backdrop-filter: blur(20px);
            padding: 0 5%;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000; height: 64px;
            border-bottom: 1px solid var(--border-red);
        }
        nav::after {
            content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, var(--red), transparent); opacity: 0.5;
        }
        .logo { font-family: 'Rajdhani', sans-serif; font-size: 1.75rem; font-weight: 700; letter-spacing: 3px; cursor: pointer; color: white; }
        .logo span { color: var(--red); text-shadow: 0 0 20px var(--red-glow); }
        .nav-links { display: flex; gap: 8px; align-items: center; }
        .nav-user-info { font-family: 'Rajdhani', sans-serif; font-size: 0.78rem; letter-spacing: 2px; color: var(--dim); border: 1px solid var(--dim2); padding: 4px 12px; border-radius: 3px; }
        .nav-btn { background: none; border: 1px solid var(--dim2); color: var(--dim); cursor: pointer; padding: 7px 16px; border-radius: 4px; font-family: 'Rajdhani', sans-serif; font-size: 0.85rem; font-weight: 600; letter-spacing: 1.5px; transition: all 0.2s; }
        .nav-btn:hover { border-color: #555; color: white; }
        .nav-btn-red { background: var(--red); border-color: var(--red); color: white; box-shadow: 0 0 15px var(--red-glow); }
        .nav-btn-red:hover { background: #ff4757; box-shadow: 0 0 25px var(--red-glow); border-color: #ff4757; }
        .nav-btn-ghost { border-color: transparent; }
        .nav-btn-ghost:hover { border-color: transparent; color: var(--red); }

        /* LAYOUT */
        .container { max-width: 1200px; margin: 0 auto; padding: 2.5rem 1.5rem; position: relative; z-index: 1; }
        .section { display: none; }
        .section.active { display: block; animation: fadeUp 0.35s ease; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }

        /* AUTH */
        .auth-wrap { max-width: 440px; margin: 3rem auto; }
        .auth-box { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 2.5rem; position: relative; overflow: hidden; }
        .auth-box::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--red), transparent); }
        .auth-label { font-family: 'Rajdhani', sans-serif; font-size: 0.72rem; letter-spacing: 4px; color: var(--red); margin-bottom: 4px; font-weight: 600; }
        .auth-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 2rem; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.72rem; letter-spacing: 1px; color: var(--dim); margin-bottom: 6px; font-family: 'Rajdhani', sans-serif; }
        input { background: var(--input-bg); border: 1px solid var(--border); color: var(--text); padding: 13px 16px; border-radius: 6px; width: 100%; font-family: 'Kanit', sans-serif; font-size: 0.9rem; transition: border-color 0.2s, box-shadow 0.2s; outline: none; }
        input:focus { border-color: var(--red); box-shadow: 0 0 0 3px var(--red-dim); }
        input::placeholder { color: var(--dim2); }
        .btn { display: block; width: 100%; padding: 13px; border: none; border-radius: 6px; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-size: 1rem; font-weight: 700; letter-spacing: 2px; transition: all 0.2s; text-transform: uppercase; }
        .btn-primary { background: var(--red); color: white; box-shadow: 0 4px 20px var(--red-glow); margin-top: 4px; }
        .btn-primary:hover:not(:disabled) { background: #ff4757; box-shadow: 0 4px 30px rgba(230,57,70,0.6); transform: translateY(-1px); }
        .btn-secondary { background: var(--card2); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover:not(:disabled) { border-color: #444; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .auth-switch { text-align: center; margin-top: 1.5rem; font-size: 0.85rem; color: var(--dim); }
        .auth-switch a { color: var(--red); cursor: pointer; font-weight: 600; }
        .auth-switch a:hover { text-decoration: underline; }

        /* PAGE HEADER */
        .page-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .page-label { font-family: 'Rajdhani', sans-serif; font-size: 0.7rem; letter-spacing: 4px; color: var(--red); margin-bottom: 4px; font-weight: 600; }
        .page-title { font-size: 1.6rem; font-weight: 700; }
        .product-count { font-size: 0.8rem; color: var(--dim); font-family: 'Rajdhani', sans-serif; }

        /* PRODUCT GRID */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .product-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; transition: all 0.3s; }
        .product-card:hover { border-color: var(--border-red); transform: translateY(-4px); box-shadow: 0 12px 40px rgba(0,0,0,0.5), 0 0 0 1px var(--border-red); }
        .product-img-wrap { position: relative; height: 200px; overflow: hidden; background: var(--bg2); }
        .product-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s; }
        .product-card:hover .product-img { transform: scale(1.05); }
        .stock-badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); border: 1px solid var(--border); padding: 3px 10px; border-radius: 20px; font-size: 0.68rem; font-family: 'Rajdhani', sans-serif; font-weight: 700; letter-spacing: 1px; }
        .stock-badge.in-stock { color: var(--green); border-color: rgba(34,197,94,0.3); }
        .stock-badge.out-stock { color: var(--red); border-color: var(--border-red); }
        .product-body { padding: 18px; }
        .product-name { font-size: 1.05rem; font-weight: 600; margin-bottom: 10px; line-height: 1.3; }
        .product-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 14px; }
        .product-price { font-family: 'Rajdhani', sans-serif; font-size: 1.65rem; font-weight: 700; color: var(--red); line-height: 1; }
        .product-price span { font-size: 0.85rem; color: var(--dim); margin-left: 2px; }
        .buy-btn { background: var(--red); color: white; border: none; padding: 9px 20px; border-radius: 5px; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-size: 0.85rem; font-weight: 700; letter-spacing: 1.5px; transition: all 0.2s; }
        .buy-btn:hover:not(:disabled) { background: #ff4757; box-shadow: 0 4px 15px var(--red-glow); }
        .buy-btn:disabled { background: var(--dim2); cursor: not-allowed; color: var(--dim); }

        /* ADMIN */
        .admin-grid { display: grid; grid-template-columns: 380px 1fr; gap: 24px; align-items: start; }
        @media (max-width: 900px) { .admin-grid { grid-template-columns: 1fr; } }
        .admin-form-box { background: var(--card); border: 1px solid var(--border-red); border-radius: 10px; padding: 1.5rem; position: sticky; top: 80px; }
        .admin-form-box h3 { font-size: 0.75rem; font-weight: 600; margin-bottom: 1.2rem; color: var(--red); font-family: 'Rajdhani', sans-serif; letter-spacing: 3px; text-transform: uppercase; }
        .admin-form-box input { margin-bottom: 10px; }
        .f-label { display: block; font-size: 0.68rem; letter-spacing: 1px; color: var(--dim); margin-bottom: 5px; margin-top: 2px; font-family: 'Rajdhani', sans-serif; }
        .form-row { display: flex; gap: 8px; margin-top: 8px; }
        .table-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        .table-card-header { padding: 14px 20px; border-bottom: 1px solid var(--border); }
        .table-card-header h3 { font-size: 0.72rem; letter-spacing: 3px; color: var(--dim); font-family: 'Rajdhani', sans-serif; font-weight: 600; text-transform: uppercase; }
        .admin-table-wrap { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { padding: 12px 16px; text-align: left; font-size: 0.68rem; letter-spacing: 2px; color: var(--dim); font-family: 'Rajdhani', sans-serif; border-bottom: 1px solid var(--border); text-transform: uppercase; }
        .data-table td { padding: 13px 16px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background: rgba(255,255,255,0.018); }
        .tbl-btn { background: none; border: 1px solid var(--dim2); color: var(--dim); padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.78rem; margin-right: 6px; transition: all 0.2s; font-family: 'Rajdhani', sans-serif; font-weight: 600; letter-spacing: 1px; }
        .tbl-btn:hover { border-color: #555; color: white; }
        .tbl-btn.del:hover { border-color: var(--red); color: var(--red); }
        .section-divider { border: none; border-top: 1px solid var(--border); margin: 2rem 0; }

        /* MODAL */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 2000; align-items: center; justify-content: center; padding: 1rem; }
        .modal.open { display: flex; animation: modalFade 0.2s ease; }
        @keyframes modalFade { from { opacity: 0; } to { opacity: 1; } }
        .modal-box { background: var(--card); border: 1px solid var(--border-red); border-radius: 14px; max-width: 500px; width: 100%; padding: 2rem; position: relative; animation: modalSlide 0.3s ease; }
        @keyframes modalSlide { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-box::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, var(--red), transparent); border-radius: 14px 14px 0 0; }
        .modal-close { position: absolute; top: 14px; right: 14px; background: none; border: none; color: var(--dim); cursor: pointer; font-size: 1.1rem; padding: 4px 8px; transition: color 0.2s; }
        .modal-close:hover { color: white; }
        .modal-item-name { font-size: 1.1rem; font-weight: 700; margin-bottom: 4px; }
        .modal-price { font-family: 'Rajdhani', sans-serif; font-size: 2rem; font-weight: 700; color: var(--red); margin-bottom: 1.5rem; line-height: 1; }
        .modal-price small { font-size: 1rem; color: var(--dim); margin-left: 2px; }
        .m-label { display: block; font-size: 0.68rem; letter-spacing: 1.5px; color: var(--dim); font-family: 'Rajdhani', sans-serif; margin-bottom: 6px; }
        .m-input { margin-bottom: 10px; }
        .verify-result { display: none; padding: 12px 14px; border-radius: 8px; font-size: 0.88rem; margin: 12px 0; line-height: 1.5; }
        .verify-result.success { background: var(--green-dim); border: 1px solid rgba(34,197,94,0.3); color: var(--green); }
        .verify-result.error { background: var(--red-dim); border: 1px solid var(--border-red); color: #ff7070; }
        .modal-actions { display: flex; flex-direction: column; gap: 8px; margin-top: 4px; }
        .download-box { display: none; background: var(--green-dim); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; padding: 16px; text-align: center; margin-top: 12px; }
        .download-box p { color: var(--green); font-size: 0.95rem; margin-bottom: 10px; }
        .download-box a { color: white; background: var(--green); padding: 10px 20px; border-radius: 6px; text-decoration: none; font-family: 'Rajdhani', sans-serif; font-weight: 700; letter-spacing: 1px; display: inline-block; transition: background 0.2s; }
        .download-box a:hover { background: #16a34a; }

        /* TOAST */
        .toast { position: fixed; bottom: 28px; right: 28px; background: var(--card2); border: 1px solid var(--border); border-radius: 8px; padding: 12px 18px; font-size: 0.88rem; z-index: 9999; opacity: 0; transform: translateY(10px); transition: all 0.3s; max-width: 300px; pointer-events: none; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { border-color: rgba(34,197,94,0.4); }
        .toast.error { border-color: var(--border-red); }

        /* EMPTY STATE */
        .empty-state { text-align: center; padding: 4rem 2rem; color: var(--dim); }
        .empty-state-icon { font-size: 2.5rem; margin-bottom: 1rem; opacity: 0.4; }

        /* SPINNER */
        .spinner { display: inline-block; width: 13px; height: 13px; border: 2px solid rgba(255,255,255,0.25); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; margin-right: 8px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }

        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--dim2); border-radius: 3px; }
    </style>
</head>
<body>

<nav>
    <div class="logo" onclick="goHome()">BPXZ<span>SHOP</span></div>
    <div class="nav-links" id="navAuth">
        <button class="nav-btn nav-btn-ghost" onclick="showSection('login')">LOGIN</button>
        <button class="nav-btn nav-btn-red" onclick="showSection('register')">REGISTER</button>
    </div>
    <div class="nav-links" id="navUser" style="display:none;">
        <span class="nav-user-info" id="userNameDisp"></span>
        <button class="nav-btn nav-btn-ghost" onclick="showSection('shop')">üõí ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
        <button class="nav-btn nav-btn-red" id="adminBtn" style="display:none;" onclick="showSection('admin')">‚öôÔ∏è ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
        <button class="nav-btn nav-btn-ghost" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
</nav>

<div class="container">

    <!-- LOGIN -->
    <section id="login" class="section active">
        <div class="auth-wrap">
            <div class="auth-box">
                <p class="auth-label">BPXZ SHOP</p>
                <h2 class="auth-title">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label">EMAIL / ADMIN ID</label>
                        <input type="text" id="loginId" placeholder="email ‡∏´‡∏£‡∏∑‡∏≠ admin id" required autocomplete="username">
                    </div>
                    <div class="form-group">
                        <label class="form-label">PASSWORD</label>
                        <input type="password" id="loginPass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="btn btn-primary" id="loginBtn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </form>
                <p class="auth-switch">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <a onclick="showSection('register')">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</a></p>
            </div>
        </div>
    </section>

    <!-- REGISTER -->
    <section id="register" class="section">
        <div class="auth-wrap">
            <div class="auth-box">
                <p class="auth-label">BPXZ SHOP</p>
                <h2 class="auth-title">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
                <form id="registerForm" onsubmit="handleRegister(event)">
                    <div class="form-group">
                        <label class="form-label">USERNAME (‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 6 ‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)</label>
                        <input type="text" id="regName" placeholder="‡πÄ‡∏ä‡πà‡∏ô player99" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">EMAIL</label>
                        <input type="email" id="regEmail" placeholder="your@email.com" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">PASSWORD (6 ‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)</label>
                        <input type="password" id="regPass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß" required minlength="6" autocomplete="new-password">
                    </div>
                    <button type="submit" class="btn btn-primary" id="regBtn">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                </form>
                <p class="auth-switch">‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? <a onclick="showSection('login')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a></p>
            </div>
        </div>
    </section>

    <!-- SHOP -->
    <section id="shop" class="section">
        <div class="page-header">
            <div>
                <p class="page-label">BPXZ SHOP</p>
                <h2 class="page-title">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
            </div>
            <span class="product-count" id="productCountText"></span>
        </div>
        <div id="productGrid" class="product-grid">
            <div class="empty-state"><div class="empty-state-icon">‚è≥</div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>
        </div>
    </section>

    <!-- ADMIN -->
    <section id="admin" class="section">
        <div class="page-header">
            <div>
                <p class="page-label">SYSTEM</p>
                <h2 class="page-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</h2>
            </div>
        </div>
        <div class="admin-grid">
            <div class="admin-form-box">
                <h3 id="formTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
                <form id="productForm" onsubmit="handleProductSubmit(event)">
                    <input type="hidden" id="editId">
                    <label class="f-label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                    <input type="text" id="pName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" required>
                    <label class="f-label">Link ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</label>
                    <input type="text" id="pImg" placeholder="https://..." required>
                    <label class="f-label">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ø)</label>
                    <input type="number" id="pPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" required min="0">
                    <label class="f-label">‡∏™‡∏ï‡πä‡∏≠‡∏Å</label>
                    <input type="number" id="pStock" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" required min="0">
                    <label class="f-label">Link ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</label>
                    <input type="text" id="pLink" placeholder="https://..." required>
                    <div class="form-row">
                        <button type="submit" class="btn btn-primary" id="submitBtn" style="flex:1;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        <button type="button" onclick="resetProductForm()" class="btn btn-secondary" style="flex:0 0 80px;">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                    </div>
                </form>
            </div>
            <div>
                <div class="table-card">
                    <div class="table-card-header"><h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3></div>
                    <div class="admin-table-wrap">
                        <table class="data-table">
                            <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏™‡∏ï‡πä‡∏≠‡∏Å</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                            <tbody id="adminTableBody"><tr><td colspan="4" style="color:var(--dim);text-align:center;padding:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr></tbody>
                        </table>
                    </div>
                </div>
                <hr class="section-divider">
                <div class="table-card">
                    <div class="table-card-header"><h3>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ‚Äî 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3></div>
                    <div class="admin-table-wrap">
                        <table class="data-table">
                            <thead><tr><th>‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏ã‡∏≠‡∏á‡∏≠‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏≤</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th></tr></thead>
                            <tbody id="orderTableBody"><tr><td colspan="5" style="color:var(--dim);text-align:center;padding:20px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>

</div>

<!-- MODAL -->
<div id="buyModal" class="modal">
    <div class="modal-box">
        <button class="modal-close" onclick="closeModal()">‚úï</button>
        <p class="modal-item-name" id="buyItemName"></p>
        <div class="modal-price" id="buyItemPrice"></div>
        <label class="m-label">‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ã‡∏≠‡∏á‡∏≠‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏≤ TRUEMONEY</label>
        <input type="text" id="walletLink" placeholder="https://gift.truemoney.com/campaign/..." class="m-input">
        <label class="m-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å TRUEMONEY</label>
        <input type="text" id="phoneNumber" placeholder="0812345678" class="m-input">
        <div id="verifyResult" class="verify-result"></div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="verifyVoucher()" id="verifyBtn">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô</button>
            <button class="btn btn-primary" onclick="processPayment()" id="payBtn" disabled>‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
        </div>
        <div id="downloadBox" class="download-box">
            <p>üéâ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</p>
            <a id="dlLink" href="#" target="_blank">‚¨áÔ∏è ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a>
        </div>
    </div>
</div>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
        getAuth, createUserWithEmailAndPassword,
        signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import {
        getFirestore, collection, addDoc, deleteDoc,
        doc, setDoc, getDoc, updateDoc, onSnapshot,
        query, where, getDocs, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCkKUrj5pHqXUvHMI-JpGWqMwlitGe7b0c",
        authDomain: "bpxzshop-2573c.firebaseapp.com",
        projectId: "bpxzshop-2573c",
        storageBucket: "bpxzshop-2573c.firebasestorage.app",
        messagingSenderId: "51423151593",
        appId: "1:51423151593:web:79c4e1c86fcf6340cff778"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let products = [];
    let currentBuyingItem = null;

    // ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
    function showToast(msg, type = 'info') {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = `toast ${type} show`;
        clearTimeout(t._t);
        t._t = setTimeout(() => t.classList.remove('show'), 3500);
    }

    // ‚îÄ‚îÄ SECTION NAV ‚îÄ‚îÄ
    window.showSection = (id) => {
        const isAdmin    = !!localStorage.getItem('bpxz_admin_session');
        const isLoggedIn = isAdmin || !!auth.currentUser;

        if (id === 'admin' && !isAdmin) {
            showToast('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô!', 'error');
            return;
        }
        if (id === 'shop' && !isLoggedIn) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô', 'error');
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('login').classList.add('active');
            return;
        }
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.goHome = () => {
        if (localStorage.getItem('bpxz_admin_session')) showSection('admin');
        else if (auth.currentUser) showSection('shop');
        else showSection('login');
    };

    // ‚îÄ‚îÄ AUTH STATE ‚îÄ‚îÄ
    onAuthStateChanged(auth, async (user) => {
        // ‚úÖ FIX: Don't override admin session UI
        if (localStorage.getItem('bpxz_admin_session')) return;

        if (user) {
            try {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    currentUser = { uid: user.uid, ...snap.data() };
                    document.getElementById('navAuth').style.display = 'none';
                    document.getElementById('navUser').style.display = 'flex';
                    document.getElementById('userNameDisp').innerText = `USER: ${currentUser.name.toUpperCase()}`;
                    document.getElementById('adminBtn').style.display = 'none';
                    
                    // ‚úÖ FIX: Redirect to shop if currently on login/register or no section active
                    const active = document.querySelector('.section.active')?.id;
                    if (!active || active === 'login' || active === 'register') {
                        showSection('shop');
                    }
                } else {
                    // User exists in Auth but not in Firestore (shouldn't happen normally)
                    console.warn("User data not found in Firestore");
                }
            } catch (e) { console.error(e); }
        } else {
            currentUser = null;
            document.getElementById('navAuth').style.display = 'flex';
            document.getElementById('navUser').style.display = 'none';
            const active = document.querySelector('.section.active')?.id;
            if (active === 'shop' || active === 'admin') {
                showSection('login');
            }
        }
    });

    // ‚îÄ‚îÄ ADMIN SESSION INIT ‚îÄ‚îÄ
    const _adminData = localStorage.getItem('bpxz_admin_session');
    if (_adminData) {
        currentUser = JSON.parse(_adminData);
        document.getElementById('navAuth').style.display = 'none';
        document.getElementById('navUser').style.display = 'flex';
        document.getElementById('userNameDisp').innerText = 'ADMIN MASTER';
        document.getElementById('adminBtn').style.display = 'block';
        
        // ‚úÖ FIX: Ensure admin section is shown
        const active = document.querySelector('.section.active')?.id;
        if (!active || active === 'login' || active === 'register') {
            showSection('admin');
        }
    }

    // ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ
    window.handleLogin = async (e) => {
        e.preventDefault();
        const id   = document.getElementById('loginId').value.trim();
        const pass = document.getElementById('loginPass').value;
        const btn  = document.getElementById('loginBtn');

        if (id === "bpxzshop" && pass === "bpxz7952") {
            localStorage.setItem('bpxz_admin_session', JSON.stringify({ name: "ADMIN MASTER", role: "admin" }));
            location.reload();
            return;
        }

        btn.innerHTML = '<span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
        btn.disabled = true;
        try {
            await signInWithEmailAndPassword(auth, id, pass);
            // onAuthStateChanged will handle the redirect
        } catch (err) {
            showToast('Email ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            btn.innerHTML = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            btn.disabled = false;
        }
    };

    // ‚îÄ‚îÄ REGISTER ‚îÄ‚îÄ
    window.handleRegister = async (e) => {
        e.preventDefault();
        const name  = document.getElementById('regName').value.trim();
        const email = document.getElementById('regEmail').value.trim();
        const pass  = document.getElementById('regPass').value;
        const btn   = document.getElementById('regBtn');

        if (!/^[a-zA-Z0-9]{6,}$/.test(name))
            return showToast('‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©/‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 6 ‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ', 'error');

        btn.innerHTML = '<span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£...';
        btn.disabled = true;
        try {
            const res = await createUserWithEmailAndPassword(auth, email, pass);
            await setDoc(doc(db, "users", res.user.uid), { name, role: "user" });
            showToast('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...', 'success');
            // onAuthStateChanged will handle the redirect
        } catch (err) {
            const msg = err.code === 'auth/email-already-in-use' ? 'Email ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß' : err.message;
            showToast(msg, 'error');
            btn.innerHTML = '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
            btn.disabled = false;
        }
    };

    // ‚îÄ‚îÄ LOGOUT ‚îÄ‚îÄ
    window.logout = async () => {
        localStorage.removeItem('bpxz_admin_session');
        await signOut(auth);
        location.reload();
    };

    // ‚îÄ‚îÄ REALTIME: PRODUCTS ‚îÄ‚îÄ
    onSnapshot(collection(db, "products"), (snap) => {
        products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderShop();
        renderAdminTable();
    });

    // ‚îÄ‚îÄ REALTIME: ORDERS (admin only) ‚îÄ‚îÄ
    onSnapshot(collection(db, "orders"), (snap) => {
        if (!localStorage.getItem('bpxz_admin_session')) return;
        const oneWeek = 7 * 24 * 60 * 60 * 1000;
        const orders = snap.docs
            .map(d => ({ ...d.data() }))
            .filter(o => (Date.now() - new Date(o.timestamp).getTime()) < oneWeek)
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        const tbody = document.getElementById('orderTableBody');
        if (tbody) {
            tbody.innerHTML = orders.length === 0
                ? '<tr><td colspan="5" style="color:var(--dim);text-align:center;padding:20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô</td></tr>'
                : orders.map(o => `
                    <tr>
                        <td>${o.userName}</td>
                        <td>${o.productName}</td>
                        <td style="color:var(--red);font-family:'Rajdhani';font-weight:700;">‡∏ø${o.price}</td>
                        <td><a href="${o.walletLink}" target="_blank" style="color:var(--green);font-size:0.8rem;">‡πÄ‡∏õ‡∏¥‡∏î‡∏ã‡∏≠‡∏á ‚Üó</a></td>
                        <td style="font-size:0.78rem;color:var(--dim);">${new Date(o.timestamp).toLocaleString('th-TH')}</td>
                    </tr>`).join('');
        }
    });

    // ‚îÄ‚îÄ RENDER SHOP ‚îÄ‚îÄ
    window.renderShop = () => {
        const grid = document.getElementById('productGrid');
        const countEl = document.getElementById('productCountText');
        if (!grid) return;
        
        if (products.length === 0) {
            grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><p style="color:var(--dim)">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p></div>';
            if (countEl) countEl.innerText = '';
            return;
        }
        if (countEl) countEl.innerText = `${products.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        grid.innerHTML = products.map(p => `
            <div class="product-card">
                <div class="product-img-wrap">
                    <img src="${p.img}" class="product-img" alt="${p.name}" onerror="this.style.opacity=0.1">
                    <span class="stock-badge ${p.stock > 0 ? 'in-stock' : 'out-stock'}">
                        ${p.stock > 0 ? `STOCK ${p.stock}` : 'SOLD OUT'}
                    </span>
                </div>
                <div class="product-body">
                    <p class="product-name">${p.name}</p>
                    <div class="product-footer">
                        <div class="product-price">${Number(p.price).toLocaleString()}<span>‡∏ø</span></div>
                        <button class="buy-btn" onclick="openBuyModal('${p.id}')" ${p.stock <= 0 ? 'disabled' : ''}>
                            ${p.stock > 0 ? 'BUY NOW' : 'SOLD OUT'}
                        </button>
                    </div>
                </div>
            </div>`).join('');
    };

    // ‚îÄ‚îÄ RENDER ADMIN TABLE ‚îÄ‚îÄ
    window.renderAdminTable = () => {
        const tbody = document.getElementById('adminTableBody');
        if (!tbody) return;
        
        tbody.innerHTML = products.length === 0
            ? '<tr><td colspan="4" style="color:var(--dim);text-align:center;padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</td></tr>'
            : products.map(p => `
                <tr>
                    <td style="font-weight:600;">${p.name}</td>
                    <td style="color:var(--red);font-family:'Rajdhani';font-weight:700;">‡∏ø${Number(p.price).toLocaleString()}</td>
                    <td style="color:${p.stock > 0 ? 'var(--green)' : 'var(--dim)'};">${p.stock}</td>
                    <td>
                        <button class="tbl-btn" onclick="editProduct('${p.id}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button class="tbl-btn del" onclick="delProduct('${p.id}')">‡∏•‡∏ö</button>
                    </td>
                </tr>`).join('');
    };

    window.handleProductSubmit = async (e) => {
        e.preventDefault();
        const id  = document.getElementById('editId').value;
        const btn = document.getElementById('submitBtn');
        const data = {
            name:         document.getElementById('pName').value.trim(),
            img:          document.getElementById('pImg').value.trim(),
            price:        Number(document.getElementById('pPrice').value),
            stock:        Number(document.getElementById('pStock').value),
            downloadLink: document.getElementById('pLink').value.trim()
        };
        btn.innerHTML = '<span class="spinner"></span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
        btn.disabled  = true;
        try {
            if (id) { await updateDoc(doc(db, "products", id), data); showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success'); }
            else    { await addDoc(collection(db, "products"), data); showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success'); }
            resetProductForm();
        } catch (err) {
            showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
        } finally {
            btn.innerHTML = id ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            btn.disabled  = false;
        }
    };

    window.editProduct = (id) => {
        const p = products.find(x => x.id === id);
        if (!p) return;
        document.getElementById('editId').value  = p.id;
        document.getElementById('pName').value   = p.name;
        document.getElementById('pImg').value    = p.img;
        document.getElementById('pPrice').value  = p.price;
        document.getElementById('pStock').value  = p.stock;
        document.getElementById('pLink').value   = p.downloadLink;
        document.getElementById('formTitle').innerText = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ${p.name}`;
        document.getElementById('submitBtn').innerText = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.resetProductForm = () => {
        document.getElementById('productForm').reset();
        document.getElementById('editId').value = '';
        document.getElementById('formTitle').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
        document.getElementById('submitBtn').innerText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
    };

    window.delProduct = async (id) => {
        const p = products.find(x => x.id === id);
        if (!p || !confirm(`‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${p.name}" ?`)) return;
        try {
            await deleteDoc(doc(db, "products", id));
            showToast('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        } catch { showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error'); }
    };

    // ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
    function resetModal() {
        document.getElementById('walletLink').value    = '';
        document.getElementById('phoneNumber').value   = '';
        const vr = document.getElementById('verifyResult');
        if (vr) {
            vr.style.display = 'none'; vr.className = 'verify-result'; vr.innerHTML = '';
        }
        const dbx = document.getElementById('downloadBox');
        if (dbx) dbx.style.display = 'none';

        const vBtn = document.getElementById('verifyBtn');
        if (vBtn) {
            vBtn.style.display = 'block';
            vBtn.disabled      = false;
            vBtn.innerHTML     = 'üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô';
        }

        const pBtn = document.getElementById('payBtn');
        if (pBtn) {
            pBtn.style.display = 'block';
            pBtn.disabled      = true;
            pBtn.innerHTML     = '‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô';
        }
    }

    window.openBuyModal = (id) => {
        currentBuyingItem = products.find(x => x.id === id);
        if (!currentBuyingItem) return;
        document.getElementById('buyItemName').innerText = currentBuyingItem.name;
        document.getElementById('buyItemPrice').innerHTML = `${Number(currentBuyingItem.price).toLocaleString()} <small>‡∏ø</small>`;
        resetModal();
        document.getElementById('buyModal').classList.add('open');
        document.body.classList.add('modal-open');
    };

    window.closeModal = () => {
        document.getElementById('buyModal').classList.remove('open');
        document.body.classList.remove('modal-open');
        currentBuyingItem = null;
    };

    document.getElementById('buyModal').addEventListener('click', e => {
        if (e.target === document.getElementById('buyModal')) closeModal();
    });

    // ‚îÄ‚îÄ VERIFY VOUCHER ‚îÄ‚îÄ
    function setVerifyResult(type, html) {
        const box = document.getElementById('verifyResult');
        if (!box) return;
        box.style.display = 'block';
        box.className = `verify-result ${type}`;
        box.innerHTML = html;
    }

    window.verifyVoucher = async () => {
        const link  = document.getElementById('walletLink').value.trim();
        const phone = document.getElementById('phoneNumber').value.trim();
        const vBtn  = document.getElementById('verifyBtn');
        const pBtn  = document.getElementById('payBtn');

        if (!link.includes("gift.truemoney.com"))
            return setVerifyResult('error', '‚ùå ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ã‡∏≠‡∏á‡∏≠‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏≤ TrueMoney');
        if (!/^0[0-9]{9}$/.test(phone))
            return setVerifyResult('error', '‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ 10 ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');

        const hashMatch = link.match(/vouchers?\/([a-zA-Z0-9]+)/);
        if (!hashMatch) return setVerifyResult('error', '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ã‡∏≠‡∏á‡πÑ‡∏î‡πâ');
        const voucherHash = hashMatch[1];

        vBtn.innerHTML = '<span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
        vBtn.disabled  = true;
        pBtn.disabled  = true;
        document.getElementById('verifyResult').style.display = 'none';

        try {
            // 1. Check duplicate
            const dupSnap = await getDocs(query(collection(db, "orders"), where("walletLink", "==", link)));
            if (!dupSnap.empty) {
                setVerifyResult('error', '‚ùå ‡∏ã‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ã‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà!');
                return;
            }

            // 2. TrueMoney API
            const apiUrl   = `https://gift.truemoney.com/campaign/vouchers/${voucherHash}/applicable-of-voucher?mobile=${phone}`;
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(apiUrl)}`;
            const res  = await fetch(proxyUrl);
            const json = await res.json();
            const data = JSON.parse(json.contents);

            if (data.status?.code === "SUCCESS") {
                const amount = parseFloat(data.data.voucher.amount_baht);
                const need   = currentBuyingItem.price;
                if (amount >= need) {
                    setVerifyResult('success', `‚úÖ ‡∏¢‡∏≠‡∏î‡πÉ‡∏ô‡∏ã‡∏≠‡∏á: <strong>${amount} ‡∏ø</strong> | ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: <strong>${need} ‡∏ø</strong><br>‚úÖ ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡∏≥‡∏£‡∏∞‡πÑ‡∏î‡πâ!`);
                    pBtn.disabled = false;
                } else {
                    setVerifyResult('error', `‚ùå ‡∏¢‡∏≠‡∏î‡πÉ‡∏ô‡∏ã‡∏≠‡∏á <strong>${amount} ‡∏ø</strong> ‡πÑ‡∏°‡πà‡∏û‡∏≠ ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ <strong>${need} ‡∏ø</strong>`);
                }
            } else if (data.status?.code === "VOUCHER_NOT_FOUND") {
                setVerifyResult('error', '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ã‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
            } else if (data.status?.code === "VOUCHER_OUT_OF_DATE") {
                setVerifyResult('error', '‚ùå ‡∏ã‡∏≠‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ã‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
            } else {
                setVerifyResult('error', `‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data.status?.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'}`);
            }

        } catch (err) {
            setVerifyResult('error', '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
            console.error(err);
        } finally {
            vBtn.innerHTML = 'üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô';
            vBtn.disabled  = false;
        }
    };

    // ‚îÄ‚îÄ PROCESS PAYMENT ‚îÄ‚îÄ
    window.processPayment = async () => {
        const link = document.getElementById('walletLink').value.trim();
        const vBtn = document.getElementById('verifyBtn');
        const pBtn = document.getElementById('payBtn');
        if (!currentBuyingItem || !link || !currentUser) return;

        pBtn.innerHTML = '<span class="spinner"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
        pBtn.disabled  = true;
        vBtn.disabled  = true;

        try {
            const productRef = doc(db, "products", currentBuyingItem.id);

            await runTransaction(db, async (tx) => {
                const snap = await tx.get(productRef);
                if (!snap.exists()) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
                const stock = snap.data().stock;
                if (stock <= 0) throw new Error("‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß");
                tx.update(productRef, { stock: stock - 1 });
                const orderRef = doc(collection(db, "orders"));
                tx.set(orderRef, {
                    userName:    currentUser.name,
                    productName: currentBuyingItem.name,
                    price:       currentBuyingItem.price,
                    walletLink:  link,
                    timestamp:   new Date().toISOString()
                });
            });

            document.getElementById('dlLink').href = currentBuyingItem.downloadLink;
            document.getElementById('downloadBox').style.display = 'block';
            document.getElementById('verifyResult').style.display = 'none';
            pBtn.style.display = 'none';
            vBtn.style.display = 'none';

        } catch (err) {
            const msg = err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
            setVerifyResult('error', `‚ùå ${msg}`);
            pBtn.innerHTML = '‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô';
            pBtn.disabled  = false;
            vBtn.disabled  = false;
        }
    };

</script>
</body>
</html>
