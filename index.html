<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPXZ SHOP - API GIFT SYSTEM</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #ff0000; --bg: #0a0a0a; --card: #121212; --text: #fff; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Kanit',sans-serif; }
        body { background: var(--bg); color: var(--text); }
        
        /* Navigation */
        nav { background: #000; padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); position: sticky; top:0; z-index: 1000; }
        nav h1 { color: var(--primary); text-transform: uppercase; cursor: pointer; }

        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px; }
        .section { display: none; background: var(--card); padding: 30px; border-radius: 15px; border: 1px solid #222; }
        .active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Buttons & Inputs */
        input { background: #1e1e1e; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 15px; outline: none; }
        input:focus { border-color: var(--primary); }
        .btn-main { background: var(--primary); color: white; padding: 12px; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; text-transform: uppercase; transition: 0.3s; }
        .btn-main:disabled { background: #444; cursor: not-allowed; }

        /* Product Card */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 20px; }
        .product-card { background: var(--card); border: 1px solid #222; border-radius: 15px; padding: 20px; text-align: center; }
        .product-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 10px; margin-bottom: 15px; }

        /* Payment Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; z-index: 2000; padding: 15px; }
        .modal-content { background: #121212; padding: 30px; border-radius: 20px; width: 100%; max-width: 400px; border: 1px solid var(--primary); text-align: center; }
        
        .status-box { margin: 15px 0; padding: 10px; border-radius: 8px; display: none; font-size: 0.9rem; }
        .success { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border: 1px solid #2ecc71; }
        .error { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c; }
    </style>
</head>
<body>

    <nav>
        <h1 onclick="location.reload()">BPXZ SHOP</h1>
        <div id="navMenu">
            <button onclick="showSection('login')" style="color:white; background:none; border:none; cursor:pointer;">Login</button>
        </div>
        <div id="userMenu" style="display:none;">
            <span id="userDisp" style="color:#aaa;"></span>
            <button onclick="logout()" style="color:var(--primary); background:none; border:none; cursor:pointer; margin-left:15px;">Logout</button>
        </div>
    </nav>

    <div class="container">
        <section id="login" class="section active">
            <h2 style="text-align:center; margin-bottom:20px;">LOGIN</h2>
            <input type="text" id="loginEmail" placeholder="Email / Admin ID">
            <input type="password" id="loginPass" placeholder="Password">
            <button class="btn-main" onclick="handleLogin()">Login</button>
        </section>

        <section id="shop" class="section">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2>STORE</h2>
                <button id="admBtn" onclick="showSection('admin')" style="display:none; color:yellow; background:none; border:1px solid yellow; padding:5px 10px; border-radius:5px; cursor:pointer;">MANAGE</button>
            </div>
            <div id="productGrid" class="product-grid"></div>
        </section>

        <section id="admin" class="section">
            <h2 id="formTitle">Manage Product</h2>
            <input type="hidden" id="editId">
            <input type="text" id="pName" placeholder="Product Name">
            <input type="number" id="pPrice" placeholder="Price (THB)">
            <input type="text" id="pImg" placeholder="Image URL">
            <input type="text" id="pLink" placeholder="Download Link">
            <button class="btn-main" id="saveBtn" onclick="saveProduct()">Save Product</button>
            <button onclick="showSection('shop')" style="width:100%; background:none; color:gray; border:none; margin-top:10px; cursor:pointer;">Back to Shop</button>
        </section>
    </div>

    <div id="payModal" class="modal">
        <div class="modal-content">
            <h3 id="buyItemName">Product Name</h3>
            <p style="margin: 10px 0;">Price: <span id="buyItemPrice" style="color:var(--primary); font-weight:bold;">0</span> ฿</p>
            <hr style="border:0; border-top:1px solid #333; margin: 15px 0;">
            
            <input type="text" id="giftLink" placeholder="วางลิงก์ซองของขวัญที่นี่">
            <button class="btn-main" id="btnConfirmPay" onclick="checkGift()">ยืนยันการจ่ายเงิน</button>
            
            <div id="statusMsg" class="status-box"></div>
            
            <div id="downloadArea" style="display:none; margin-top:15px; border:2px dashed #2ecc71; padding:15px; border-radius:10px;">
                <p style="color:#2ecc71; margin-bottom:5px;">จ่ายเงินสำเร็จ!</p>
                <a id="fileLink" href="#" target="_blank" style="color:white; text-decoration:underline;">คลิกเพื่อรับสินค้า</a>
            </div>

            <button onclick="closeModal()" style="margin-top:20px; color:#666; background:none; border:none; cursor:pointer;">ยกเลิก</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCkKUrj5pHqXUvHMI-JpGWqMwlitGe7b0c",
            authDomain: "bpxzshop-2573c.firebaseapp.com",
            projectId: "bpxzshop-2573c",
            storageBucket: "bpxzshop-2573c.firebasestorage.app",
            messagingSenderId: "51423151593",
            appId: "1:51423151593:web:79c4e1c86fcf6340cff778"
        };

        // *************** เปลี่ยนข้อมูล API ตรงนี้ ***************
        const API_CONF = {
            url: "https://www.planariashop.com/api/truewallet.php",
            keyapi: "33c60ebefce44b2660a326ed7335d8de", // API Key ของคุณ
            phone: "0950189983" // เบอร์ที่รับเงิน
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let selectedItem = null;

        // --- Auth ---
        window.handleLogin = async () => {
            const email = loginEmail.value.trim(), pass = loginPass.value.trim();
            if(email === "bpxzshop" && pass === "bpxz7952") { localStorage.setItem('isAdmin', 'true'); location.reload(); return; }
            try { await signInWithEmailAndPassword(auth, email, pass); } catch (e) { alert("Login Failed"); }
        };

        onAuthStateChanged(auth, (user) => {
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            if (user || isAdmin) {
                document.getElementById('navMenu').style.display = 'none';
                document.getElementById('userMenu').style.display = 'block';
                document.getElementById('userDisp').innerText = isAdmin ? "ADMIN" : user.displayName || user.email;
                if(isAdmin) document.getElementById('admBtn').style.display = 'inline';
                showSection('shop');
            }
        });

        // --- UI & Products ---
        window.showSection = (id) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };

        let allProducts = [];
        onSnapshot(collection(db, "products"), (snap) => {
            allProducts = snap.docs.map(d => ({id: d.id, ...d.data()}));
            const isAdmin = localStorage.getItem('isAdmin') === 'true';
            document.getElementById('productGrid').innerHTML = allProducts.map(p => `
                <div class="product-card">
                    <img src="${p.img}">
                    <h3>${p.name}</h3>
                    <p style="color:var(--primary); font-weight:bold; margin:10px 0;">${p.price} THB</p>
                    <button class="btn-main" onclick="openPayModal('${p.id}')">Buy Now</button>
                    ${isAdmin ? `<div style="margin-top:10px; display:flex; gap:5px;">
                        <button onclick="editProduct('${p.id}')" style="flex:1; background:#333; color:white; border:none; padding:5px; border-radius:5px; cursor:pointer;">Edit</button>
                        <button onclick="deleteProduct('${p.id}')" style="flex:1; background:#400; color:red; border:none; padding:5px; border-radius:5px; cursor:pointer;">Del</button>
                    </div>` : ''}
                </div>`).join('');
        });

        // --- ระบบชำระเงิน API ---
        window.openPayModal = (id) => {
            selectedItem = allProducts.find(p => p.id === id);
            buyItemName.innerText = selectedItem.name;
            buyItemPrice.innerText = selectedItem.price;
            giftLink.value = "";
            statusMsg.style.display = 'none';
            downloadArea.style.display = 'none';
            btnConfirmPay.disabled = false;
            btnConfirmPay.innerText = "ยืนยันการจ่ายเงิน";
            document.getElementById('payModal').style.display = 'flex';
        };

        window.checkGift = async () => {
            const link = giftLink.value.trim();
            if(!link.includes("gift.truemoney.com")) return alert("ลิงก์ซองไม่ถูกต้อง");

            btnConfirmPay.disabled = true;
            btnConfirmPay.innerText = "กำลังตรวจสอบ...";
            statusMsg.style.display = 'none';

            try {
                const formData = new URLSearchParams();
                formData.append('keyapi', API_CONF.keyapi);
                formData.append('phone', API_CONF.phone);
                formData.append('gift_link', link);

                const response = await fetch(API_CONF.url, {
                    method: 'POST',
                    body: formData
                });
                const res = await response.json();

                if(res.status === "success") {
                    const amount = parseFloat(res.amount);
                    if(amount >= selectedItem.price) {
                        statusMsg.innerText = "ได้รับเงิน: " + amount + " ฿ (สำเร็จ)";
                        statusMsg.className = "status-box success";
                        statusMsg.style.display = "block";
                        fileLink.href = selectedItem.downloadLink;
                        downloadArea.style.display = "block";
                    } else {
                        statusMsg.innerText = "จำนวนเงินไม่ครบ! ต้องการ " + selectedItem.price + " ฿ แต่ซองมีแค่ " + amount + " ฿";
                        statusMsg.className = "status-box error";
                        statusMsg.style.display = "block";
                        btnConfirmPay.disabled = false;
                        btnConfirmPay.innerText = "ลองอีกครั้ง";
                    }
                } else {
                    statusMsg.innerText = res.message || "ลิงก์ซองถูกใช้งานแล้ว หรือผิดพลาด";
                    statusMsg.className = "status-box error";
                    statusMsg.style.display = "block";
                    btnConfirmPay.disabled = false;
                    btnConfirmPay.innerText = "ลองอีกครั้ง";
                }
            } catch (e) {
                alert("API ขัดข้อง กรุณาลองใหม่ภายหลัง");
                btnConfirmPay.disabled = false;
            }
        };

        // --- Admin Functions ---
        window.saveProduct = async () => {
            const data = { name: pName.value, price: Number(pPrice.value), img: pImg.value, downloadLink: pLink.value };
            if(editId.value) await updateDoc(doc(db, "products", editId.value), data);
            else await addDoc(collection(db, "products"), data);
            resetForm(); showSection('shop');
        };
        window.editProduct = (id) => {
            const p = allProducts.find(x => x.id === id);
            editId.value=p.id; pName.value=p.name; pPrice.value=p.price; pImg.value=p.img; pLink.value=p.downloadLink;
            formTitle.innerText = "Edit: " + p.name; showSection('admin');
        };
        window.deleteProduct = async (id) => { if(confirm("ลบ?")) await deleteDoc(doc(db, "products", id)); };
        window.resetForm = () => { editId.value=""; pName.value=""; pPrice.value=""; pImg.value=""; pLink.value=""; formTitle.innerText="Manage Product"; };
        window.closeModal = () => document.getElementById('payModal').style.display = 'none';
        window.logout = () => { localStorage.clear(); signOut(auth).then(() => location.reload()); };
    </script>
</body>
</html>
